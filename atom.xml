<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Ales Nosek - The Software Practitioner]]></title>
  <link href="http://alesnosek.com/atom.xml" rel="self"/>
  <link href="http://alesnosek.com/"/>
  <updated>2015-08-03T22:45:41-07:00</updated>
  <id>http://alesnosek.com/</id>
  <author>
    <name><![CDATA[Ales Nosek]]></name>

  </author>
  <generator uri="http://octopress.org/">Octopress</generator>


  <entry>
    <title type="html"><![CDATA[Improving Ansible's ini_file module]]></title>
    <link href="http://alesnosek.com/blog/2015/08/03/improving-ansibles-ini-file-module/"/>
    <updated>2015-08-03T20:01:30-07:00</updated>
    <id>http://alesnosek.com/blog/2015/08/03/improving-ansibles-ini-file-module</id>
    <content type="html"><![CDATA[<p>For editing Windows INI files, Ansible comes with an <code>ini_file</code> module built in. Unfortunately, this module uses Python&rsquo;s <code>ConfigParser</code> module which reformats the entire INI file whenever you want to change a single line. It removes all the comment lines, too. For me this was not acceptable. After looking for a possible solution I decided to improve the <code>ini_file</code> module and created <code>ini_file2</code>. I realized how easy it is to create an Ansible module.</p>

<!-- more -->


<p>On Debian Linux, the Ansible&rsquo;s built-in <code>ini_file</code> module can be found at <code>/usr/share/ansible/files/ini_file</code>. This file is the base for our own <code>ini_file2</code>. The question was, at what location should one store the <code>ini_file2</code> module for Ansible to find it? From Ansible&rsquo;s <a href="http://docs.ansible.com/ansible/developing_modules.html" title="Developing Modules">documentation</a> I learned that when looking for modules, Ansible searches the <code>./library</code> directory alongside of the top level playbooks. That sounds perfect to me.</p>

<p>After a while working with the Python code, I created the <code>ini_file2</code> module. This module provides an equivalent functionality to the original <code>ini_file</code> module, however, it does only the minimum changes when editing the INI file. It typically modifies only one line. When removing options, it doesn&rsquo;t delete the lines but comment them out instead. If there was a commented out option it comments it in when required.</p>

<h2>The ini_file and ini_file2 comparison</h2>

<p>Let&rsquo;s compare the <code>ini_file</code> and <code>ini_file2</code> on a practical example. Our input INI file looks as follows:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ini'><span class='line'><span class="c1"># This is the main configuration section</span>
</span><span class='line'><span class="c1"># There are some important options to configure</span>
</span><span class='line'><span class="k">[main]</span>
</span><span class='line'><span class="c1"># This is the first option</span>
</span><span class='line'><span class="na">option1</span> <span class="o">=</span> <span class="s">orig_value</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># This is the second option</span>
</span><span class='line'><span class="c1"># If not set, the default value is def_value</span>
</span><span class='line'><span class="c1"># option2 = def_value</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># This is the last option</span>
</span><span class='line'><span class="c1"># If not set, the default value is def_value</span>
</span><span class='line'><span class="na">option3</span> <span class="o">=</span> <span class="s">some_value</span>
</span></code></pre></td></tr></table></div></figure>


<p>The Ansible test script will set the <code>option1</code> and <code>option2</code> to <code>new_value</code> and it will remove the <code>option3</code> from the INI file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- name: Set option1 to new_value
</span><span class='line'>  ini_file: dest=settings.ini section=main option=option1 value=new_value
</span><span class='line'>
</span><span class='line'>- name: Set option2 to new_value
</span><span class='line'>  ini_file: dest=settings.ini section=main option=option2 value=new_value
</span><span class='line'>
</span><span class='line'>- name: Remove option3
</span><span class='line'>  ini_file: dest=settings.ini section=main option=option3 state=absent</span></code></pre></td></tr></table></div></figure>


<p>When using the original <code>ini_file</code> module, the resulting INI file looks like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ini'><span class='line'><span class="k">[main]</span>
</span><span class='line'><span class="na">option1</span> <span class="o">=</span> <span class="s">new_value</span>
</span><span class='line'><span class="na">option2</span> <span class="o">=</span> <span class="s">new_value</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can see that there&rsquo;s not much left from the input file. All comments are gone. In contrast, the <code>ini_file2</code> module does the editing operations with more precision:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ini'><span class='line'><span class="c1"># This is the main configuration section</span>
</span><span class='line'><span class="c1"># There are some important options to configure</span>
</span><span class='line'><span class="k">[main]</span>
</span><span class='line'><span class="c1"># This is the first option</span>
</span><span class='line'><span class="na">option1</span> <span class="o">=</span> <span class="s">new_value</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># This is the second option</span>
</span><span class='line'><span class="c1"># If not set, the default value is def_value</span>
</span><span class='line'><span class="na">option2</span> <span class="o">=</span> <span class="s">new_value</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># This is the last option</span>
</span><span class='line'><span class="c1"># If not set, the default value is def_value</span>
</span><span class='line'><span class="c1">#option3 = some_value</span>
</span></code></pre></td></tr></table></div></figure>


<h2>References</h2>

<p>The <code>ini_file2</code> source code as well as test scripts can be found at <a href="https://github.com/noseka1/ini_file2" title="ini_file2">GitHub</a>.</p>
]]></content>
  </entry>

  <entry>
    <title type="html"><![CDATA[Browsing Docker Source using Eclipse]]></title>
    <link href="http://alesnosek.com/blog/2015/07/19/browsing-docker-source-using-eclipse/"/>
    <updated>2015-07-19T20:59:12-07:00</updated>
    <id>http://alesnosek.com/blog/2015/07/19/browsing-docker-source-using-eclipse</id>
    <content type="html"><![CDATA[<p>Do you like Docker technology and want to learn more about it? There&rsquo;s no better way to learn than reading the source code. In this article, we&rsquo;ll install the Go programming language, download the latest Docker source code and navigate through it in Eclipse.</p>

<!-- more -->


<h2>Installing the Go programming language</h2>

<p>The Go programming language is relatively young and sees a lot of development. Within the past two years there was a major release available every half a year. To keep up with the latest state of art it&rsquo;s better to install Go packages directly from the project&rsquo;s <a href="https://golang.org/dl/" title="Go Downloads">download site</a> instead of trying to make use of the packages coming with your Linux distribution. Currently, Docker requires Go version 1.4 or later. Before you start the installation, make sure that there are no Go packages installed on your system. The following command will uninstall all Go packages from your Debian-based Linux:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>sudo apt-get purge golang*
</span></code></pre></td></tr></table></div></figure>


<p>After you&rsquo;ve downloaded the Go binary distribution tarball your can install it with:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>sudo tar -C /usr/local -xzf go1.4.2.linux-amd64.tar.gz
</span></code></pre></td></tr></table></div></figure>


<p>This will extract the archive into the <code>/usr/local/go</code> directory. The Go distributions assume they will be installed in <code>/usr/local/go</code>. If you install Go into a different location you&rsquo;ll have to set the <code>GOROOT</code> environment variable. For more information on the Go installation refer to the Go&rsquo;s <a href="http://golang.org/doc/install" title="Getting Started">Getting Started</a> page.</p>

<p>The <code>/usr/local/go/bin</code> includes the Go tool (the <code>go</code> command). We&rsquo;ll use this tool to download and compile Docker. You want to have the Go tool available on your path:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:/usr/local/go/bin
</span></code></pre></td></tr></table></div></figure>


<h2>Creating a Go workspace</h2>

<p>The Go <em>workspace</em> is a directory with three subdirectories:</p>

<ul>
<li><code>src</code> is where the source code resides</li>
<li><code>pkg</code> is where the libraries are stored</li>
<li><code>bin</code> is where the executables reside</li>
</ul>


<p>Typically, Go programmers keep <em>all</em> their source code and dependencies (libraries) in a single workspace. It means that all your Go projects are located in a single workspace.</p>

<p>The workspace can be created at an arbitrary location. In order for Go tool to find the available workspaces, you must list them in the <code>GOPATH</code> environment variable. We&rsquo;ll define a single workspace under the current user&rsquo;s home directory:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nb">export </span><span class="nv">GOPATH</span><span class="o">=</span><span class="nv">$HOME</span>/go
</span><span class='line'><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:<span class="nv">$GOPATH</span>/bin
</span></code></pre></td></tr></table></div></figure>


<p>At the same time, we&rsquo;ve included the workspace&rsquo;s <code>bin</code> directory into our path variable. Whenever we build an executable it&rsquo;ll be instantly available for us to use. Note that the workspace directory doesn&rsquo;t exist yet. Go tool will automatically create it when we download the Docker source code.</p>

<p>Furher information on the Go code organization and workspaces can be found <a href="http://golang.org/doc/code.html" title="How to Write Go Code">here</a>.</p>

<h2>Building Docker from source</h2>

<p>So far, we&rsquo;ve defined the location of our Go workspace. Now we&rsquo;re going to download the latest Docker code and build it. The Go tool can directly download the Docker Git repository and save it into our workspace:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>go get -d github.com/docker/docker
</span></code></pre></td></tr></table></div></figure>


<p>Now we can change our directory to the cloned Git repository and start the build:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nb">cd</span> <span class="nv">$HOME</span>/go/src/github.com/docker/docker
</span><span class='line'><span class="nv">GOPATH</span><span class="o">=</span><span class="nv">$HOME</span>/go:<span class="nv">$HOME</span>/go/src/github.com/docker/docker/vendor ./hack/make.sh dynbinary
</span></code></pre></td></tr></table></div></figure>


<p>Docker comes with a set of dependencies directly checked into the Docker Git repository. You can find them in the <code>vendor</code> directory. This directory is actually a Go workspace which we only needed to include in our <code>GOPATH</code> when we triggered the build. If everything went fine, you can find some generated source files in the <code>autogen</code> directory and the freshly built Docker executables in the <code>bundles</code> directory.</p>

<h2>Creating an Eclipse project</h2>

<p>In this section, we&rsquo;re going to install a Go language plug-in into Eclipse IDE and create a Docker project. The <a href="https://github.com/GoClipse/goclipse" title="GoClipse">GoClipse</a> plug-in brings Go language support into Eclipse. The minimum installation requirements for this plug-in are: Eclipse 4.5 (Mars) running on Java 8 or later. You can follow the installation instructions available <a href="https://github.com/GoClipse/goclipse/blob/latest/documentation/Installation.md" title="GoClipse installation">here</a> to get the plug-in installed.</p>

<p>After the successful plug-in installation and restart of Eclipse select <code>File -&gt; New -&gt; Project ...</code>. Choose <code>Go Project</code> in the dialog box. You&rsquo;ll be presented with a window similar to:</p>

<p><img class="center" src="http://alesnosek.com/images/posts/eclipse_go1.png"></p>

<p>Instead of using the default location, let Eclipse create the project in your Go workspace. After your Go project has been created, go to <code>Window -&gt; Preferences</code> and find the tab with the Go configuration. You want to set the location of your Go language installation to the standard <code>/usr/local/go</code> directory. Make sure you set the <code>GOOS</code> and <code>GOARCH</code> fields, too. You&rsquo;ll also have to add the path to the Docker&rsquo;s <code>vendor</code> directory into the <code>GOPATH</code> field.</p>

<p><img class="center" src="http://alesnosek.com/images/posts/eclipse_go2.png"></p>

<h2>Code navigation and auto-completion</h2>

<p>In this final section, we&rsquo;re going to make navigation and auto-completion in Eclipse work. The <code>Open Definition</code> navigation in Eclipse (keyboard shorcut F3) requires the Go <code>oracle</code> tool to be installed. Whenever you open the definition of the entity under the cursor, Eclipse will call the <code>oracle</code> tool in order to obtain the information about the navigation target.</p>

<p>The <code>oracle</code> tool is part of a bigger Go toolset located <a href="https://github.com/golang/tools" title="Golang tools">here</a>. You can easily install the <code>oracle</code> tool using the <code>go</code> command. Type this in your console:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>go get golang.org/x/tools/cmd/oracle
</span></code></pre></td></tr></table></div></figure>


<p>You can run this command to confirm that the <code>oracle</code> tool was installed successfully:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>oracle --help
</span></code></pre></td></tr></table></div></figure>


<p>The source code navigation in Eclipse using the F3 keyboard shortcut should start working. Let&rsquo;s focus on the code auto-completion (Ctrl+Space) next. In order to make the auto-completion work, we need to install an auto-completion daemon for the Go programming language <a href="https://github.com/nsf/gocode" title="gocode">gocode</a>. The installation with the <code>go</code> tool is pretty simple:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>go get github.com/nsf/gocode
</span></code></pre></td></tr></table></div></figure>


<p>To confirm that the <code>gocode</code> tool was installed successfully type:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>gocode --help
</span></code></pre></td></tr></table></div></figure>


<p>Eclipse provides a configuration dialog for Go tools under <code>Window -&gt; Preferences</code>. There are even buttons to click and install the <code>oracle</code> and <code>gocode</code> tools from within Eclipse. We did this installation on the command-line.</p>

<p><img class="center" src="http://alesnosek.com/images/posts/eclipse_go3.png"></p>

<p>Now that you&rsquo;re all set I wish you happy browsing through the Docker source code!</p>
]]></content>
  </entry>

  <entry>
    <title type="html"><![CDATA[Running Wine within Docker]]></title>
    <link href="http://alesnosek.com/blog/2015/07/04/running-wine-within-docker/"/>
    <updated>2015-07-04T22:46:55-07:00</updated>
    <id>http://alesnosek.com/blog/2015/07/04/running-wine-within-docker</id>
    <content type="html"><![CDATA[<p>After upgrading to Debian Jessie, my Windows application running under Wine stopped working. In this article we&rsquo;ll use Docker to restore the Wine environment from Debian Wheezy. We&rsquo;ll run the Windows application inside this Docker container.</p>

<!-- more -->


<p>Docker is not part of the stable Jessie distribution, however, you can install it from the <a href="http://backports.debian.org/" title="Debian Backports">Debian Backports</a> repositories.</p>

<h2>Creating a Docker image</h2>

<p>We start off with creating a Docker image based on the <code>debian:wheezy</code> image from the official Docker repositories. We&rsquo;ll install the 32-bit Wine package on it. The Wine application is a graphical application and hence requires access to the X server. Setting the environmet variable <code>DISPLAY=:0</code> instructs the application to access the local X server. The complete <code>Dockerfile</code> to build our Wine image looks as follows:</p>

<figure class='code'><figcaption><span>Dockerfile </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>FROM debian:wheezy
</span><span class='line'>RUN dpkg --add-architecture i386
</span><span class='line'>RUN apt-get update
</span><span class='line'>RUN apt-get install --no-install-recommends --assume-yes wine
</span><span class='line'>ENV DISPLAY :0
</span></code></pre></td></tr></table></div></figure>


<p>You can kick off the build of the <code>wine1.4</code> image with:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>docker build --rm -t wine1.4 .
</span></code></pre></td></tr></table></div></figure>


<p>After a minute or two the build is complete and the resulting image is stored locally on your Docker host. You can take a look using the <code>docker images</code> command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>docker images <span class="p">|</span> grep wine1.4
</span><span class='line'>wine1.4                   latest              b300b8573303        About a minute ago   271.3 MB
</span></code></pre></td></tr></table></div></figure>


<h2>Running Wine within a Docker container</h2>

<p>To test our <code>wine1.4</code> Docker image, we&rsquo;ll run the <code>notepad</code> application which comes with Wine:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>docker run --rm wine1.4 wine <span class="s2">&quot;C:\windows\system32\notepad.exe&quot;</span>
</span><span class='line'>wine: created the configuration directory <span class="s1">&#39;/root/.wine&#39;</span>
</span><span class='line'>Application tried to create a window, but no driver could be loaded.
</span><span class='line'>Make sure that your X server is running and that <span class="nv">$DISPLAY</span> is <span class="nb">set </span>correctly.
</span><span class='line'>err:systray:initialize_systray Could not create tray window
</span><span class='line'>Application tried to create a window, but no driver could be loaded.
</span><span class='line'>Make sure that your X server is running and that <span class="nv">$DISPLAY</span> is <span class="nb">set </span>correctly.
</span><span class='line'>Application tried to create a window, but no driver could be loaded.
</span><span class='line'>Make sure that your X server is running and that <span class="nv">$DISPLAY</span> is <span class="nb">set </span>correctly.
</span><span class='line'>Application tried to create a window, but no driver could be loaded.
</span><span class='line'>Make sure that your X server is running and that <span class="nv">$DISPLAY</span> is <span class="nb">set </span>correctly.
</span><span class='line'>
</span><span class='line'>....
</span></code></pre></td></tr></table></div></figure>


<p>The <code>notepad</code> application doesn&rsquo;t really start. From the generated error output we can see that our application is unable to access the X server. Well, there&rsquo;s no X server running inside the container. In order to allow the application running inside the container to access the X server running on the Docker host, we&rsquo;ll expose the host&rsquo;s X server UNIX domain socket inside the container. We can ask Docker to bind mount the <code>/tmp/.X11-unix/X0</code> UNIX socket to the same location inside the container using the <code>--volume</code> parameter:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>docker run --rm --volume /tmp/.X11-unix/X0:/tmp/.X11-unix/X0 wine1.4 wine <span class="s2">&quot;C:\windows\system32\notepad.exe&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>When we run the above command, Wine starts up successfully and the notepad application opens up. Inside the Docker container Wine runs as user root and starts from scratch with no existing configuration:</p>

<p><img class="center" src="http://alesnosek.com/images/posts/wine.png"></p>

<p>We would like Wine running inside the Docker container to use the existing Wine configuration stored on the Docker host. Let&rsquo;s copy the existing Wine configuration on the host to a new directory which we&rsquo;ll in turn expose inside the Docker container:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span><span class="nb">cd</span> ~
</span><span class='line'><span class="nv">$ </span>cp -a .wine .wine.docker
</span></code></pre></td></tr></table></div></figure>


<p>The <code>.wine.docker</code> directory can be exposed inside the Docker container  with the command-line parameter <code>--volume /home/anosek/.wine.docker:/home/anosek/.wine</code>. The Wine configuration in <code>.wine.docker</code> is in my case owned by the user <code>anosek</code>. We want Docker to run as user <code>anosek</code> instead of the default <code>root</code> user. In order to accomplish this, two additional parameters to the Docker <code>run</code> command are needed: <code>--volume /etc/passwd:/etc/passwd</code> and <code>--user anosek</code>. We&rsquo;re bind mounting the <code>/etc/passwd</code> file including the definition of user <code>anosek</code> inside the Docker container and asking Docker to run as user <code>anosek</code>.</p>

<p>The complete command to run Wine inside the Docker container as user <code>anosek</code> and using the existing Wine configuration found in the <code>/home/anosek/.wine.docker</code> directory on the host looks as follows:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>docker run --rm --volume /tmp/.X11-unix/X0:/tmp/.X11-unix/X0 --volume /home/anosek/.wine.docker:/home/anosek/.wine --volume /etc/passwd:/etc/passwd --user anosek wine1.4 wine <span class="s2">&quot;C:\windows\system32\notepad.exe&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Conclusion</h2>

<p>One can leverage the modern Docker technology to create a specific Wine environment on any Linux system. To achieve this a little bit of configuration is required, though. In case of Wine you might be better off using some of the specialized tools for Wine management. For instance, <a href="https://www.playonlinux.com/" title="PlayOnLinux">PlayOnLinux</a> can manage different versions of Wine as well as different prefixes (<code>WINEPREFIX</code> environment variable).</p>
]]></content>
  </entry>

  <entry>
    <title type="html"><![CDATA[Diagrams and Images in Doxygen]]></title>
    <link href="http://alesnosek.com/blog/2015/06/28/diagrams-and-images-in-doxygen/"/>
    <updated>2015-06-28T21:54:54-07:00</updated>
    <id>http://alesnosek.com/blog/2015/06/28/diagrams-and-images-in-doxygen</id>
    <content type="html"><![CDATA[<p>Is your technical documentation hard to read? Diagrams and images liven up technical documentation and help the reader to better understand the subject. In the last article of the Doxygen miniseries we&rsquo;ll go over a couple of options how to include diagrams and images in Doxygen documentation.</p>

<!-- more -->


<p>In order to show the graphical capabilities of Doxygen I created a sample project. You can check out the project source code and the generated HTML and PDF output at:</p>

<ul>
<li><a href="https://github.com/noseka1/diagrams-and-images-in-doxygen" title="diagrams-and-images-in-doxygen">Source code on GitHub</a></li>
<li><a href="http://noseka1.github.com/diagrams-and-images-in-doxygen">The generated HTML output</a></li>
<li><a href="http://noseka1.github.com/diagrams-and-images-in-doxygen/refman.pdf">The generated PDF output</a></li>
</ul>


<p>Doxygen on its own doesn&rsquo;t implement graphical operations. However, it can include diagrams and images generated by external tools.</p>

<h2>DOT graphs</h2>

<p>The DOT language allows for simple definition of graphs. You can find a great documentation with many examples of DOT graphs in the manual <a href="http://www.graphviz.org/Documentation/dotguide.pdf" title="Drawing graphs with dot">Drawing graphs with dot</a>. Doxygen tag <code>@dot</code> allows for embedding the DOT graph definition directly into your documentation. The nodes of the graph can be made hyperlinks as it is demonstrated in the sample project. Doxygen itself uses DOT graphs to generate the class inheritance and call graph diagrams. In order to generate the DOT diagrams you need to have <code>dot</code> utility installed. On most distributions the <code>dot</code> utility can be found in the <code>graphviz</code> package.</p>

<h2>MSC sequence diagrams</h2>

<p><a href="http://www.mcternan.me.uk/mscgen/" title="Mscgen">Mscgen</a> is a handy utility for generating sequence diagrams. On many Linux distributions you can find it in the <code>mscgen</code> package. Similarly to DOT graphs, the parts of the mscgen diagrams can be made clickable, too. In Doxygen, you can include a MSC diagram by using <code>@msc</code> tag.</p>

<h2>PlantUML diagrams</h2>

<p>All kinds of UML diagrams can be created with <a href="http://plantuml.sourceforge.net/" title="PlantUML">PlantUML</a>. To learn about the different PlantUML features you can refer to the great reference guide <a href="http://plantuml.sourceforge.net/PlantUML_Language_Reference_Guide.pdf" title="Drawing UML with PlantUML">Drawing UML with PlantUML</a>. PlatUML is implemented in Java. You&rsquo;ll need to download the jar file <code>plantuml.jar</code> and tell the jar location to Doxygen in your <code>Doxyfile</code>. The definition of a PlantUML diagram in Doxygen must be enclosed in the <code>@startuml</code> and <code>@enduml</code> tags.</p>

<h2>Dia diagrams</h2>

<p>If you prefer drawing your diagrams directly instead of defining them as a plain text the <a href="http://dia-installer.de/" title="Dia Diagram Editor">Dia Diagram Editor</a> can be a good fit for you. On many Linux distributions come with a <code>dia</code> package. After you have created your dia file you insert it into the Doxygen documentation using the <code>@diafile</code> Doxygen tag.</p>

<h2>Inserting images</h2>

<p>Last thing that our sample project illustrates is inserting images into Doxygen documentation. You&rsquo;ll need to have your images ready in several graphical formats (<code>.svg</code>, <code>.eps</code>, &hellip;) depending on which Doxygen ouput you&rsquo;re willing to generate. For example, for <em>Latex</em> output the images must be provided in Encapsulated PostScript (<code>.eps</code>). Example of including the same image in multiple formats for <em>HTML</em> and <em>Latex</em> outputs:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@image html people.svg
</span><span class='line'>@image latex people.eps "People image" width=\textwidth</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>

  <entry>
    <title type="html"><![CDATA[The Structure of Doxygen Documentation]]></title>
    <link href="http://alesnosek.com/blog/2015/06/21/the-structure-of-doxygen-documentation/"/>
    <updated>2015-06-21T17:48:59-07:00</updated>
    <id>http://alesnosek.com/blog/2015/06/21/the-structure-of-doxygen-documentation</id>
    <content type="html"><![CDATA[<p>Let&rsquo;s review some basic means that Doxygen provides to structure your documentation. If you&rsquo;re a newcomer to Doxygen this blogpost might be useful for you.</p>

<!-- more -->


<p>In order to demonstrate Doxygen features I created a sample project. You can check out the project source code and the generated HTML ouput at:</p>

<ul>
<li><a href="https://github.com/noseka1/structure-of-doxygen-doc" title="structure-of-doxygen-doc">Source code on GitHub</a></li>
<li><a href="http://noseka1.github.com/structure-of-doxygen-doc/">The generated HTML output</a></li>
</ul>


<p>The tree view in the generated HTML output looks as follows:</p>

<p><img class="center" src="http://alesnosek.com/images/posts/doxygen_treeview.png"></p>

<h2>Doxygen pages</h2>

<p>Pages in Doxygen are used for documentation that is not directly attached to the source code entity like class, file or member. They will typically contain a longer description of your project. You can refer to any source code entity from within the page if required.</p>

<p>There&rsquo;s always a project main page created by the Doxygen tag <code>@mainpage</code>. In our example, the title of the main page is <code>My Project</code>. All other pages listed under the main page are created using the Doxygen tag <code>@page</code>. In our example, we&rsquo;re using Markdown files where the <code>@page</code> tag is assumed and you&rsquo;re not required to write it. Doxygen automatically generates a page for every file with the <code>.markdown</code> extension. We talked about Markdown support in Doxygen in my <a href="http://alesnosek.com/blog/2015/06/14/technical-documentation-with-doxygen/" title="Technical Documentation with Doxygen">previous blogpost</a>.
The page hierarchy is created by the repetitive use of the Doxygen tag <code>@subpage</code>. The <code>@subpage</code> tag creates a parent-child relationship between two pages. It generates a reference (link) to the subpage at the same time. Example:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># The List of subpages:
</span><span class='line'>
</span><span class='line'>* Page @subpage subpage_1
</span><span class='line'>* Page @subpage subpage_2
</span><span class='line'>* Page @subpage subpage_3</span></code></pre></td></tr></table></div></figure>


<h2>Doxygen modules</h2>

<p>A larger software project typically consists of multiple modules. A module implements a particular project functionality. Doxygen cannot know which classes, files or namespaces belong to which module in your project. If you want to structure your documentation based on modules you&rsquo;ll need to tag each class, file or namespace with the module name. This allows Doxygen to understand your modularized design and generate the documentation accordingly.</p>

<p>You can start with a definition of your modules and their parent-child relationship in a separate Doxygen file. A module is defined using <code>@defgroup</code> Doxygen tag. In our example, we&rsquo;re defining a parent module <code>My Project Modules</code> with two submodules <code>Math library</code> and <code>Misc library</code>:</p>

<figure class='code'><figcaption><span>doxygen/group_defs.dox </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * @defgroup group_main My Project Modules</span>
</span><span class='line'><span class="cm"> * @brief All project modules</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * @{</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/** @defgroup group_math Math library */</span>
</span><span class='line'><span class="cm">/** @defgroup group_misc Misc library */</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/** @} */</span>
</span></code></pre></td></tr></table></div></figure>


<p>Later in the source code, you can associate a class, file or a namespace with a module by using a Doxygen tag <code>@ingroup</code>:</p>

<figure class='code'><figcaption><span>src/math/factorial.h </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#ifndef MYPROJECT_MATH_FACTORIAL_H</span>
</span><span class='line'><span class="cp">#define MYPROJECT_MATH_FACTORIAL_H</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/** @ingroup group_math */</span>
</span><span class='line'><span class="n">namespace</span> <span class="n">myproject</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">namespace</span> <span class="n">math</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/** @ingroup group_math */</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">fact</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">#endif</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Namespaces, classes and files</h2>

<p>Doxygen automatically generates a list of namespaces, classes and files for you.</p>
]]></content>
  </entry>

  <entry>
    <title type="html"><![CDATA[Technical Documentation with Doxygen]]></title>
    <link href="http://alesnosek.com/blog/2015/06/14/technical-documentation-with-doxygen/"/>
    <updated>2015-06-14T22:04:36-07:00</updated>
    <id>http://alesnosek.com/blog/2015/06/14/technical-documentation-with-doxygen</id>
    <content type="html"><![CDATA[<p>Do you create project documentation in your company&rsquo;s internal wiki? I did it for quite some time until I realized that a good old Doxygen combined with Git can do a much better job.</p>

<!-- more -->


<p><a href="http://www.stack.nl/~dimitri/doxygen/" title="Doxygen">Doxygen</a> is a well-known tool for generating documentation directly out of the annotated source code. However, it can be utilized to create technical documentation, too. In version 1.8.0, <a href="http://www.stack.nl/~dimitri/doxygen/manual/markdown.html" title="Markdown support">Markdown support</a> was introduced to Doxygen. <a href="http://daringfireball.net/projects/markdown/" title="Markdown">Markdown</a> is a popular markup language. Plain text files written in Markdown format can be converted into HTML or many other formats. With Markdown support, creating technical documentation in Doxygen gets really easy.</p>

<h2>Doxygen sample project</h2>

<p>To get started, I read a <a href="http://svenax.net/site/2013/07/creating-user-documentation-with-doxygen/" title="Creating user documentation with Doxygen">very useful article</a> describing how to enable support of plain Markdown files in Doxygen and a couple of gotchas one might encounter. Gotchas? No worries! In record time I was able to create sample technical documentation. As sample content I used a couple of articles from my blog which were also coded in Markdown. Now I&rsquo;d like to share the project with you:</p>

<ul>
<li><a href="https://github.com/noseka1/tech-doc-with-doxygen" title="tech-doc-with-doxygen">Source code on GitHub</a></li>
<li><a href="http://noseka1.github.com/tech-doc-with-doxygen/">The generated HTML output</a></li>
<li><a href="http://noseka1.github.com/tech-doc-with-doxygen/refman.pdf">The generated PDF output</a></li>
<li><a href="http://noseka1.github.com/tech-doc-with-doxygen/refman.rtf">The generated RTF output</a></li>
</ul>


<p>The project shows a basic document structure. If you want to learn more about Doxygen I recommend downloading the Doxygen source distribution <a href="http://www.stack.nl/~dimitri/doxygen/download.html">tarball</a> or clone the Doxygen&rsquo;s project <a href="https://github.com/doxygen/doxygen">Git repository</a>. After extracting the tar archive go to the <code>doc</code> directory where you can find the sources of the Doxygen&rsquo;s <a href="http://www.stack.nl/~dimitri/doxygen/index.html" title="Doxygen">webpage</a>. You can learn a lot by reading through them.</p>

<p>Doxygen provides good support for creating graphs and diagrams in your technical document. For instance, you can insert graphs in <a href="https://en.wikipedia.org/wiki/DOT_(graph_description_language" title="DOT">DOT</a> format with <code>@dot</code> or <code>@dotfile</code> tags. You can include <a href="http://www.mcternan.me.uk/mscgen/" title="MSC">MSC</a> sequence diagrams with <code>@msc</code> or <code>@mscfile</code> tags. To insert decent looking <a href="http://plantuml.sourceforge.net/" title="PlantUML">PlantUML</a> UML diagrams use <code>@startuml</code> tag. If you like to draw your diagrams in <a href="http://dia-installer.de/" title="Dia">Dia</a> you can insert them to Doxygen via <code>@diafile</code> tag.</p>

<h2>Conclusion</h2>

<p>Doxygen is a very powerful documentation tool. Chances are that you&rsquo;re already using it to generate a documentation from your source code. It makes a lot of sense to me to use Doxygen for project documentation instead of creating it in the Wiki. If you combine Doxygen with a good source control (e.g. Git) you gain the following benefits:</p>

<ul>
<li>History tracking and branching that no Wiki can provide</li>
<li>The same development workflow for your documentation as well as for your source code</li>
<li>Project documentation and source code at one place and possibly referencing each other</li>
</ul>

]]></content>
  </entry>

  <entry>
    <title type="html"><![CDATA[Seven Tips for Better Code]]></title>
    <link href="http://alesnosek.com/blog/2015/06/06/seven-tips-for-better-code/"/>
    <updated>2015-06-06T21:04:36-07:00</updated>
    <id>http://alesnosek.com/blog/2015/06/06/seven-tips-for-better-code</id>
    <content type="html"><![CDATA[<p>It&rsquo;s a pleasure to read and maintain your code, right? Software practice teaches that code is written once but read many times. Your teammates will appreciate it if you put your effort into writing a good looking and understandable code. Needless to say that when you&rsquo;ll read your code one year later you&rsquo;ll appreciate it, too. Let&rsquo;s discuss a couple of basic guidelines to write a better code.</p>

<!-- more -->


<h2>1) Respect the pre-existing coding style</h2>

<p>You&rsquo;ve just joined a software project that run for a while. The coding conventions used on the project are weird and you really don&rsquo;t like them. Perhaps, they force you to put parenthesis on a new line or let you write variable names with the first letter in capital while you&rsquo;d prefer a small letter. They even violate the existing Java or C# language conventions. And the <a href="http://en.wikipedia.org/wiki/Hungarian_notation" title="Hungarian notation">Hungarian notation</a> looks just awful!</p>

<p>As a professional software developer, you&rsquo;ll find yourself in this situation many times. Unless you can reformat the code of the entire project it&rsquo;s better to stick with the coding style that&rsquo;s already in place. In other words, you should follow the already established coding style regardless whether  you like it or not. Perhaps, you can propose a change of coding style to your teammates when you&rsquo;re starting to work on a new project.</p>

<h2>2) Tabs versus spaces</h2>

<p>Is it better to use tabs or spaces to indent your code? Well, pick one but stick with it throughout your entire project. I prefer spaces because they let my code look the same in all editors. My editor is configured to convert tabs into spaces so that I don&rsquo;t have to tap on the space bar too much when indenting.</p>

<h2>3) Break your code down into methods</h2>

<p>It&rsquo;s a good practice to break down a complicated program logic into multiple methods. By doing so, you make it easier for the reader to understand the purpose of your code. Look at the following code example. Can you explain what the code is doing?</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="c1">// Bloated program logic, don&#39;t do this!</span>
</span><span class='line'>    <span class="n">String</span> <span class="nf">retrieveData</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">String</span> <span class="n">data</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">data</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">BufferedReader</span> <span class="n">br</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">br</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="nf">FileReader</span><span class="o">(</span><span class="s">&quot;file.txt&quot;</span><span class="o">));</span>
</span><span class='line'>                <span class="n">data</span> <span class="o">=</span> <span class="n">br</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class='line'>                <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                    <span class="k">if</span> <span class="o">(</span><span class="n">br</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                        <span class="n">br</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span><span class='line'>                    <span class="o">}</span>
</span><span class='line'>                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>            <span class="n">cache</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">data</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">data</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The aim of the code is pretty simple. When retrieving data, look if the requested data is in the cache first and if not fetch it from the file. If the data was read from the file, put it into the cache to speed up the succeeding lookups. Let&rsquo;s rewrite the code example to make this logic apparent to the reader:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="n">String</span> <span class="nf">retrieveData</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">String</span> <span class="n">data</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">data</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">data</span> <span class="o">=</span> <span class="n">readDataFromFile</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span><span class='line'>            <span class="n">cache</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">data</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">data</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">String</span> <span class="nf">readDataFromFile</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">String</span> <span class="n">data</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>        <span class="n">BufferedReader</span> <span class="n">br</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">br</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="nf">FileReader</span><span class="o">(</span><span class="s">&quot;file.txt&quot;</span><span class="o">));</span>
</span><span class='line'>            <span class="n">data</span> <span class="o">=</span> <span class="n">br</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">br</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">br</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">data</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The caching logic is now separate from the details of how to read the data from the file. Splitting the logic up into two methods greatly increased readability.</p>

<h2>4) Avoid excessive access to your instance variables</h2>

<p>Object-oriented programming introduced a <em>class</em> abstraction. Class groups the data with the code that can modify the data. Instead of using global variables that are accessible from any part of your program you can encapsulate your data with the code into a class. The scope where your data is accessible is now limited to the class members. However, your data is accessible by <em>any</em> class member. Assuming a very large class definition with a lot of members the data members can start feeling as a new form of global variables. I&rsquo;d like to suggest to you avoiding excessive access to your data members. Look at the following example:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">class</span> <span class="nc">Number</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kt">int</span> <span class="n">number</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kt">int</span> <span class="n">increment</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">increment</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">incrementNumber</span><span class="o">();</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">number</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">incrementNumber</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// direct access to instance variable &quot;number&quot;. Not too good.</span>
</span><span class='line'>        <span class="n">number</span> <span class="o">=</span> <span class="n">number</span> <span class="o">+</span> <span class="n">increment</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the code above the instance variable <code>number</code> is accessed from within two methods: <code>increment</code> and <code>incrementNumber</code>. Should it happen that the instance variable <code>number</code> is not set to the value you expected you&rsquo;ll need to review both methods because they&rsquo;re both accessing the problematic variable <code>number</code>.</p>

<p>The following version of the same code accesses the instance variable <code>number</code> only from within the method <code>increment</code>. The method <code>incrementNumber</code> is working only with a copy of the <code>number</code> variable created on the stack. When searching for a problem you&rsquo;ll start reviewing the <code>increment</code> method and possibly follow the data flow into the <code>incrementNumber</code> method when needed. Also, if you&rsquo;d like to reuse the code of the method <code>incrementNumber</code> it&rsquo;s easier to do now. The method <code>incrementNumber</code> doesn&rsquo;t access any instance variables and so you can separate it out into a <em>class</em> method right away.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">class</span> <span class="nc">Number</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kt">int</span> <span class="n">number</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kt">int</span> <span class="n">increment</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">increment</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">number</span> <span class="o">=</span> <span class="n">incrementNumber</span><span class="o">(</span><span class="n">number</span><span class="o">,</span> <span class="n">increment</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">number</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kt">int</span> <span class="nf">incrementNumber</span><span class="o">(</span><span class="kt">int</span> <span class="n">num</span><span class="o">,</span> <span class="kt">int</span> <span class="n">inc</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// no access to instance variables</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">num</span> <span class="o">+</span> <span class="n">inc</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>5) Prevent maintenance issues</h2>

<p>Look at the following code. Can you see a problem?</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="o">)</span>
</span><span class='line'>        <span class="n">value</span><span class="o">++;</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>        <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'>        <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&quot;Value overflow&quot;</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>The intention of the maintainer was to add an error message for the case that the value overflowed number 10. However, the code as it is written will log the error message in any case. When coding think about the future maintenance and use parenthesis to make very clear what the <code>if</code> and <code>else</code> parts are:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">value</span><span class="o">++;</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>When the maintainer tries to add an error message to this code he cannot introduce the bug illustrated in the previous code example. Out of curiosity, the Linux kernel project advocates no parenthesis around the if-else statement if not necessary. As always, the existing coding conventions take precedence.</p>

<h2>6) Use braces to make expressions more readable</h2>

<p>Programming languages define operator precedence and it&rsquo;s great that you&rsquo;re aware of it. Not every programmer has mastered the operator precedence and associativity table, though. Be kind and code your expressions very clearly. Braces can help you:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="c1">// relying on operator precedence</span>
</span><span class='line'><span class="k">if</span> <span class="o">(</span><span class="n">a</span> <span class="o">&amp;&amp;</span> <span class="n">b</span> <span class="o">||</span> <span class="n">a</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// making very clear how the expression is evaluated</span>
</span><span class='line'><span class="k">if</span> <span class="o">((</span><span class="n">a</span> <span class="o">&amp;&amp;</span> <span class="n">b</span><span class="o">)</span> <span class="o">||</span> <span class="o">(</span><span class="n">a</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>7) Learn your programming language idioms</h2>

<p>There&rsquo;s no perfect programming language. Idioms get invented to work around the quirks of a specific programming language. Using idioms improves the maintanability of the code. You should learn and use them wherever possible. For Java idioms you can refer to <a href="http://c2.com/ppr/wiki/JavaIdioms/JavaIdioms.html" title="Java Idioms">Java Idioms</a> and <a href="http://www.nayuki.io/page/good-java-idioms" title="Good Java Idioms">Good Java Idioms</a>.</p>
]]></content>
  </entry>

  <entry>
    <title type="html"><![CDATA[OpenStack Dynamic DNS Updates]]></title>
    <link href="http://alesnosek.com/blog/2015/05/31/openstack-dynamic-dns-updates/"/>
    <updated>2015-05-31T22:49:39-07:00</updated>
    <id>http://alesnosek.com/blog/2015/05/31/openstack-dynamic-dns-updates</id>
    <content type="html"><![CDATA[<p>Today&rsquo;s user story is: As a private cloud user I&rsquo;d like to have virtual machines registered with internal DNS. Let&rsquo;s look at how a software practitioner solves this problem in a truly agile way.</p>

<!-- more -->


<p>The OpenStack <a href="https://wiki.openstack.org/wiki/Designate" title="Designate">Designate</a> project implements DNSaaS. After trying out Designate, I realized that for simple DNS updates DNSaaS is a little too involved.</p>

<p>In my previous <a href="http://alesnosek.com/blog/2015/05/25/openstack-nova-notifications-subscriber" title="OpenStack Nova Notifications Subscriber">article</a> I described how to monitor Nova events on RabbitMQ message bus. Two events of interest are <code>compute.instance.create.end</code> and <code>compute.instance.delete.start</code> that are sent by Nova on instance creation and instance deletion. Both events carry enough information for us to create a simple script to extract the hostname and IP addresses of the instance from the events and update the internal DNS using the <code>nsupdate</code> command.</p>

<p>You can find the DNS updates implementantion including the systemd startup script at GitHub: <a href="https://github.com/noseka1/openstack-dns-updater" title="openstack-dns-updater">openstack-dns-updater</a>.</p>
]]></content>
  </entry>

  <entry>
    <title type="html"><![CDATA[OpenStack Nova Notifications Subscriber]]></title>
    <link href="http://alesnosek.com/blog/2015/05/25/openstack-nova-notifications-subscriber/"/>
    <updated>2015-05-25T08:42:41-07:00</updated>
    <id>http://alesnosek.com/blog/2015/05/25/openstack-nova-notifications-subscriber</id>
    <content type="html"><![CDATA[<p>OpenStack components generate notifications that can provide useful insight into what is going on in OpenStack. Let&rsquo;s create a simple subcriber that dumps incoming notifications from OpenStack Nova to standard output.</p>

<!-- more -->


<h2>Configure Nova to generate notifications</h2>

<p>First let&rsquo;s make sure that Nova is configured to send out notifications. You should find the following lines in your <code>/etc/nova/nova.conf</code> file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ini'><span class='line'><span class="k">[DEFAULT]</span>
</span><span class='line'><span class="na">notification_topics</span><span class="o">=</span><span class="s">notifications</span>
</span><span class='line'><span class="na">notification_driver</span><span class="o">=</span><span class="s">messagingv2</span>
</span><span class='line'><span class="na">notify_on_state_change</span><span class="o">=</span><span class="s">vm_state</span>
</span></code></pre></td></tr></table></div></figure>


<p>Property <code>notification_topics</code> determines the base name of the topic (routing key) where the notification messages are sent to. The full name of the topic where the info-level notifications are published is <code>notifications.info</code>.
The possible choices of notification driver are briefly described in <a href="http://docs.openstack.org/developer/oslo.messaging/FAQ.html" title="Frequently Asked Questions">oslo.messaging FAQ</a>. The <code>messagingv2</code> option instructs Nova to send notifications using the 2.0 message format that wraps the messages into an oslo.messaging envelope. The <code>notify_on_state_change</code> property determines the kind of notifications Nova should send out. You can set its value to <code>vm_and_task_state</code> if you want to receive additional notifications. After you modified your <code>/etc/nova/nova.conf</code> restart the Nova components for changes to take effect:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>sudo systemctl restart openstack-nova-api
</span><span class='line'>sudo systemctl restart openstack-nova-compute
</span><span class='line'>sudo systemctl restart openstack-nova-conductor
</span><span class='line'>sudo systemctl restart openstack-nova-scheduler
</span></code></pre></td></tr></table></div></figure>


<h2>Implement Nova notifications subscriber</h2>

<p>Internally, Nova uses <a href="https://kombu.readthedocs.org/en/latest/" title="Kombu Documentation">Kombu</a> messaging library to connect to the RabbitMQ message broker. Let&rsquo;s use this Python library in our notifications subscriber to avoid the need to install additional libraries.</p>

<p>Nova sends out notification messages to a <em>topic</em> exchange called <code>nova</code> with the routing key <code>notifications.info</code>. In order to receive notification messages our client application needs to create a queue and bind it to the <code>nova</code> exchange. The binding key used to bind the queue to the <code>nova</code> exchange must match the routing key used by Nova to send out notification messages. Whenever there&rsquo;s a new message in the queue the Kombu library will invoke the <code>on_message</code> callback on our client to handle the message. The complete code of our notifications subscriber looks as follows:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#!/usr/bin/env python</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">sys</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">logging</span> <span class="kn">as</span> <span class="nn">log</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">kombu</span> <span class="kn">import</span> <span class="n">BrokerConnection</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">kombu</span> <span class="kn">import</span> <span class="n">Exchange</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">kombu</span> <span class="kn">import</span> <span class="n">Queue</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">kombu.mixins</span> <span class="kn">import</span> <span class="n">ConsumerMixin</span>
</span><span class='line'>
</span><span class='line'><span class="n">EXCHANGE_NAME</span><span class="o">=</span><span class="s">&quot;nova&quot;</span>
</span><span class='line'><span class="n">ROUTING_KEY</span><span class="o">=</span><span class="s">&quot;notifications.info&quot;</span>
</span><span class='line'><span class="n">QUEUE_NAME</span><span class="o">=</span><span class="s">&quot;nova_dump_queue&quot;</span>
</span><span class='line'><span class="n">BROKER_URI</span><span class="o">=</span><span class="s">&quot;amqp://guest:guest@localhost:5672//&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">log</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">stream</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">log</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">NotificationsDump</span><span class="p">(</span><span class="n">ConsumerMixin</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">connection</span>
</span><span class='line'>        <span class="k">return</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">get_consumers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">consumer</span><span class="p">,</span> <span class="n">channel</span><span class="p">):</span>
</span><span class='line'>        <span class="n">exchange</span> <span class="o">=</span> <span class="n">Exchange</span><span class="p">(</span><span class="n">EXCHANGE_NAME</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;topic&quot;</span><span class="p">,</span> <span class="n">durable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'>        <span class="n">queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="n">QUEUE_NAME</span><span class="p">,</span> <span class="n">exchange</span><span class="p">,</span> <span class="n">routing_key</span> <span class="o">=</span> <span class="n">ROUTING_KEY</span><span class="p">,</span> <span class="n">durable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">auto_delete</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">no_ack</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">[</span> <span class="n">consumer</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">callbacks</span> <span class="o">=</span> <span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_message</span> <span class="p">])</span> <span class="p">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">on_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
</span><span class='line'>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Body: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">body</span><span class="p">)</span>
</span><span class='line'>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;---------------&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
</span><span class='line'>    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Connecting to broker {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">BROKER_URI</span><span class="p">))</span>
</span><span class='line'>    <span class="k">with</span> <span class="n">BrokerConnection</span><span class="p">(</span><span class="n">BROKER_URI</span><span class="p">)</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
</span><span class='line'>        <span class="n">NotificationsDump</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>After you run the notifications subscriber and if everything went fine you should see the output similar to:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>INFO:root:Connecting to broker amqp://guest:guest@localhost:5672//
</span><span class='line'>DEBUG:amqp:Start from server, version: 0.9, properties: {u'information': u'Licensed under the MPL.  See http://www.rabbitmq.com/', u'product': u'RabbitMQ', u'copyright': u'Copyright (C) 2007-2014 GoPivotal, Inc.', u'capabilities': {u'exchange_exchange_bindings': True, u'connection.blocked': True, u'authentication_failure_close': True, u'basic.nack': True, u'per_consumer_qos': True, u'consumer_priorities': True, u'consumer_cancel_notify': True, u'publisher_confirms': True}, u'cluster_name': u'rabbit@rdo-controller', u'platform': u'Erlang/OTP', u'version': u'3.3.5'}, mechanisms: [u'AMQPLAIN', u'PLAIN'], locales: [u'en_US']
</span><span class='line'>DEBUG:amqp:Open OK!
</span><span class='line'>INFO:kombu.mixins:Connected to amqp://guest@127.0.0.1:5672//
</span><span class='line'>DEBUG:amqp:using channel_id: 1
</span><span class='line'>DEBUG:amqp:Channel open</span></code></pre></td></tr></table></div></figure>


<p>Whenever you create/delete an instance in OpenStack a host of notification messages should be rolling on your screen.</p>

<h2>Troubleshooting</h2>

<p>RabbitMQ comes with a <code>rabbitmqctl</code> command which can be used to inspect the state of the exchanges, queues and bindings in the running RabbitMQ instance. First let&rsquo;s check that the <code>nova</code> topic exchange exists:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>sudo rabbitmqctl list_exchanges <span class="p">|</span> grep nova
</span><span class='line'>nova    topic
</span></code></pre></td></tr></table></div></figure>


<p>Next let&rsquo;s make sure that our consumer queue was successfully created:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>sudo rabbitmqctl list_queues <span class="p">|</span> grep nova_dump_queue
</span><span class='line'>nova_dump_queue 0
</span></code></pre></td></tr></table></div></figure>


<p>As a last thing we want to double-check that our <code>nova_dump_queue</code> was bound with the <code>nova</code> exchange using the binding key <code>notifications.info</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>sudo rabbitmqctl list_bindings <span class="p">|</span> grep nova_dump_queue
</span><span class='line'>        exchange        nova_dump_queue queue   nova_dump_queue <span class="o">[]</span>
</span><span class='line'>nova    exchange        nova_dump_queue queue   notifications.info      <span class="o">[]</span>
</span></code></pre></td></tr></table></div></figure>


<h2>References</h2>

<p>You can find more detailed information on topic exchanges in the great RabbitMQ tutorial <a href="https://www.rabbitmq.com/tutorials/tutorial-five-python.html" title="Topics">here</a>. A version of the Nova notifications subscriber implemented with Python <a href="http://pika.readthedocs.org/en/latest/" title="Introduction to Pika">Pika</a> library is described in <a href="https://prosuncsedu.wordpress.com/2014/01/08/notification-of-actions-in-openstack-nova/" title="Action Notifications in OpenStack nova">this</a> blogpost.</p>
]]></content>
  </entry>

  <entry>
    <title type="html"><![CDATA[Five Basic Tips for Logging in Java]]></title>
    <link href="http://alesnosek.com/blog/2015/05/18/five-basic-tips-for-logging-in-java/"/>
    <updated>2015-05-18T01:11:47-07:00</updated>
    <id>http://alesnosek.com/blog/2015/05/18/five-basic-tips-for-logging-in-java</id>
    <content type="html"><![CDATA[<p>Where do you look when your server application doesn&rsquo;t work as expected? Application logs can provide invaluable information when the systems in production misbehave. That&rsquo;s why a great software practitioner desings the application logs carefully. Let&rsquo;s review a couple of basic tips for great logging in Java.</p>

<!-- more -->


<h2>1) Use SLF4J logging facade</h2>

<p>There are different Java logging frameworks out there: java.util.logging, Log4j, Log4j2 and Logback to name the most popular ones. <a href="http://www.slf4j.org/" title="Simple Logging Facade for Java (SLF4J)">SLF4J</a> is a thin facade that can talk to all of these logging frameworks. You can write your code using the SLF4J API and plugin in the desired logging framework at deployment time. Instead of tying yourself to Log4j framework like this code example does:</p>

<figure class='code'><figcaption><span>Log4jApp.java </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">import</span> <span class="nn">org.apache.log4j.Logger</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Log4jApp</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="n">Logger</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">Log4jApp</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;Application using Log4j directly&quot;</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Write your application using the SLF4J API:</p>

<figure class='code'><figcaption><span>Slf4jApp.java </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Slf4jApp</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">LogApp</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;Application using SLF4J facade&quot;</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the second example you can see no <code>org.apache.log4j</code> package dependencies. At deployment time you can indeed plug-in Log4j framework as a logging backend but you can also opt for some of the other logging alternatives. You can refer to my <a href="http://alesnosek.com/blog/2015/05/11/java-logging-quick-reference/" title="Java Logging Quick Reference">previous article</a> on how to configure SLF4J with different logging frameworks.</p>

<p>If you&rsquo;re writing a library and need to do logging you should definitely consider using SLF4J. Having your library depend on a particular logging framework will not make your users happy if they prefer to deploy a different logging framework. Even when writing a stand-alone application you might come to the point when you need to break it up into libraries when it gets bigger. Save your time and use SLF4J up front.</p>

<h2>2) Keep the logging performance in mind</h2>

<p>You can improve the performance of your logging code by embracing the following programming idioms.</p>

<p>Instead of concatenating strings to form the logging message let the logging framework do it for you. In the following example assume that the log level was set to <code>info</code>, therefore debug messages won&rsquo;t be logged at all. The code at line 5 is concatenating five string objects in order to create one temporary string object which is not used anyway. You should instead follow the example at line 8. The formatting of the log message is done by the logging framework which is optimized to do the formatting only if the resulting message will actually be logged. Besides that, the code at line 8 is more readable than the variant at line 5.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">String</span> <span class="n">foo</span> <span class="o">=</span> <span class="s">&quot;foo&quot;</span><span class="o">;</span>
</span><span class='line'><span class="n">String</span> <span class="n">bar</span> <span class="o">=</span> <span class="s">&quot;bar&quot;</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// don&#39;t do this!</span>
</span><span class='line'><span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&quot;Value of foo is &quot;</span> <span class="o">+</span> <span class="n">foo</span> <span class="o">+</span> <span class="s">&quot;. Value of bar is &quot;</span> <span class="o">+</span> <span class="n">bar</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// do this instead</span>
</span><span class='line'><span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&quot;Value of foo is {}. Value of bar is {}.&quot;</span><span class="o">,</span> <span class="n">foo</span><span class="o">,</span> <span class="n">bar</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>If it is expensive to obtain the data to be logged make sure that the log level is high enough before you go to retrieve the data. The example below fetches the debug data from the database only if the current log level is <code>debug</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="k">if</span> <span class="o">(</span><span class="n">log</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">String</span> <span class="n">data</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// ...</span>
</span><span class='line'>  <span class="c1">// fetch the data from the database</span>
</span><span class='line'>  <span class="c1">// ...</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&quot;Data from the database: &quot;</span> <span class="o">+</span> <span class="n">data</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>3) Log Java exceptions</h2>

<p>Even if you&rsquo;d like to ignore Java exceptions at some places, do at least log it before you ignore it. Logging frameworks can log the stack trace of the Java exception nicely. The code in the following example catches and logs a <code>NullPointerException</code>:</p>

<figure class='code'><figcaption><span>LogException.java </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LogException</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">LogException</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">exceptionalMethod</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">(</span><span class="s">&quot;My exception to be logged&quot;</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">exceptionalMethod</span><span class="o">();</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>      <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&quot;Something went wrong&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This produces the following output in your logs:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>22:16:58.677 [main] ERROR LogException - Something went wrong
</span><span class='line'>java.lang.NullPointerException: My exception to be logged
</span><span class='line'>  at LogException.exceptionalMethod(LogException.java:9) ~[bin/:na]
</span><span class='line'>  at LogException.main(LogException.java:13) ~[bin/:na]</span></code></pre></td></tr></table></div></figure>


<h2>4) Mark and filter your log messages</h2>

<p>Java logging frameworks allow you to filter log messages based on the logger name and the message log level. Logback and Log4j2 frameworks come with an additional filtering facility: Markers. You can tag your log messages with user-defined markers in order to filter them later on. In our example, we want to store the timing messages in a separate log file for later processing. In order to accomplish this we&rsquo;ll mark timing messages with the <code>time</code> marker. You can see the definition of the <code>time</code> marker at line 19 and logging of the marked message at line 20:</p>

<figure class='code'><figcaption><span>MarkerApp.java </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">mport</span> <span class="n">org</span><span class="o">.</span><span class="na">slf4j</span><span class="o">.</span><span class="na">Logger</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.slf4j.Marker</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.slf4j.MarkerFactory</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MarkerApp</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">MarkerApp</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">static</span> <span class="kt">void</span> <span class="nf">processRequest</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;Log info message&quot;</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="kt">long</span> <span class="n">startTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
</span><span class='line'>      <span class="n">processRequest</span><span class="o">();</span>
</span><span class='line'>      <span class="kt">long</span> <span class="n">endTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">Marker</span> <span class="n">timeMarker</span> <span class="o">=</span> <span class="n">MarkerFactory</span><span class="o">.</span><span class="na">getMarker</span><span class="o">(</span><span class="s">&quot;time&quot;</span><span class="o">);</span>
</span><span class='line'>      <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">timeMarker</span><span class="o">,</span> <span class="s">&quot;Request processing took {} ms&quot;</span><span class="o">,</span> <span class="o">(</span><span class="n">endTime</span> <span class="o">-</span> <span class="n">startTime</span><span class="o">)/</span><span class="mi">1</span><span class="n">e6</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the logging configuration file we&rsquo;ll create two log appenders. The console appender sends all logging messages to the console output. In addition, the file appender logs only the messages marked with the <code>time</code> marker into the <code>/tmp/logger.out</code> log file.</p>

<figure class='code'><figcaption><span>log4j2.marker.xml </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;Configuration&gt;</span>
</span><span class='line'>    <span class="nt">&lt;Appenders&gt;</span>
</span><span class='line'>        <span class="nt">&lt;Console</span> <span class="na">name=</span><span class="s">&quot;console&quot;</span> <span class="na">target=</span><span class="s">&quot;SYSTEM_OUT&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>            <span class="nt">&lt;PatternLayout</span> <span class="na">pattern=</span><span class="s">&quot;%d{HH:mm:ss} [%t] %-5p %c{1}:%L - %m%n&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/Console&gt;</span>
</span><span class='line'>        <span class="nt">&lt;File</span> <span class="na">name=</span><span class="s">&quot;file&quot;</span> <span class="na">fileName=</span><span class="s">&quot;/tmp/logger.out&quot;</span> <span class="na">append=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>            <span class="nt">&lt;PatternLayout</span> <span class="na">pattern=</span><span class="s">&quot;%d{HH:mm:ss} [%t] %-5p %c{1}:%L - %m%n&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;Filters&gt;</span>
</span><span class='line'>                <span class="nt">&lt;MarkerFilter</span> <span class="na">marker=</span><span class="s">&quot;time&quot;</span> <span class="na">onMatch=</span><span class="s">&quot;ACCEPT&quot;</span> <span class="na">onMismatch=</span><span class="s">&quot;DENY&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;/Filters&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/File&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/Appenders&gt;</span>
</span><span class='line'>    <span class="nt">&lt;Loggers&gt;</span>
</span><span class='line'>        <span class="nt">&lt;Root</span> <span class="na">level=</span><span class="s">&quot;debug&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>            <span class="nt">&lt;AppenderRef</span> <span class="na">ref=</span><span class="s">&quot;console&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;AppenderRef</span> <span class="na">ref=</span><span class="s">&quot;file&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/Root&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/Loggers&gt;</span>
</span><span class='line'><span class="nt">&lt;/Configuration&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you run the example you&rsquo;ll see the following output on your console:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>22:55:48 [main] INFO  MarkerApp:11 - Log info message
</span><span class='line'>22:55:48 [main] INFO  MarkerApp:20 - Request processing took 12.09897 ms</span></code></pre></td></tr></table></div></figure>


<p>You will find only the marked timing message in the <code>/tmp/logger.out</code> log file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>22:55:48 [main] INFO  MarkerApp:20 - Request processing took 12.09897 ms</span></code></pre></td></tr></table></div></figure>


<h2>5) Leverage diagnostic context in multithreaded applications</h2>

<p>Most server applications need to handle multiple clients simultaneously. Typically, the server application allocates a separate thread to handle a single client request. In such a system different threads handle different client requests in parallel and the log messages written by the threads interleave. In order to differentiate log messages from different threads from each other a diagnostic context comes in handy. Diagnostic context is a map associated with a particular thread. Each thread maintains its own map. You can store arbitrary key-value pairs in the map and in turn lay out your log messages to include the values from the map.</p>

<p>In the following example we want to log the name of the user on behalf of which we&rsquo;re doing some processing. In order to accomplish this we store the name of the user in the map under the key <code>user</code> before we start the processing. After the processing is complete we clear the map to get it ready for the next user.</p>

<figure class='code'><figcaption><span>MdcApp.java </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.slf4j.MDC</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MdcApp</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">MdcApp</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">static</span> <span class="kt">void</span> <span class="nf">process</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;Processing 1&quot;</span><span class="o">);</span>
</span><span class='line'>      <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;Processing 2&quot;</span><span class="o">);</span>
</span><span class='line'>      <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;Processing 3&quot;</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">MDC</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">,</span> <span class="s">&quot;Joe&quot;</span><span class="o">);</span>
</span><span class='line'>      <span class="n">process</span><span class="o">();</span>
</span><span class='line'>      <span class="n">MDC</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
</span><span class='line'>      <span class="n">MDC</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">,</span> <span class="s">&quot;Eleonora&quot;</span><span class="o">);</span>
</span><span class='line'>      <span class="n">process</span><span class="o">();</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the logging configuration we need to configure the <code>PatternLayout</code> to include the <code>user</code> value from the map. The <code>%X{user}</code> formatting sequence does exactly that.</p>

<figure class='code'><figcaption><span>log4j2.mdc.xml </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;Configuration&gt;</span>
</span><span class='line'>    <span class="nt">&lt;Appenders&gt;</span>
</span><span class='line'>        <span class="nt">&lt;Console</span> <span class="na">name=</span><span class="s">&quot;console&quot;</span> <span class="na">target=</span><span class="s">&quot;SYSTEM_OUT&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>            <span class="nt">&lt;PatternLayout</span> <span class="na">pattern=</span><span class="s">&quot;%d{HH:mm:ss} [%t] [%X{user}] %p %m%n&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/Console&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/Appenders&gt;</span>
</span><span class='line'>    <span class="nt">&lt;Loggers&gt;</span>
</span><span class='line'>        <span class="nt">&lt;Root</span> <span class="na">level=</span><span class="s">&quot;debug&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>            <span class="nt">&lt;AppenderRef</span> <span class="na">ref=</span><span class="s">&quot;console&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/Root&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/Loggers&gt;</span>
</span><span class='line'><span class="nt">&lt;/Configuration&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>When you run the <code>MdcApp</code> application you&rsquo;ll see the following output on your console:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>00:01:30 [main] [Joe] INFO Processing 1
</span><span class='line'>00:01:30 [main] [Joe] INFO Processing 2
</span><span class='line'>00:01:30 [main] [Joe] INFO Processing 3
</span><span class='line'>00:01:30 [main] [Eleonora] INFO Processing 1
</span><span class='line'>00:01:30 [main] [Eleonora] INFO Processing 2
</span><span class='line'>00:01:30 [main] [Eleonora] INFO Processing 3</span></code></pre></td></tr></table></div></figure>


<p>Now you can tell the name of the user for whom you did the processing.</p>
]]></content>
  </entry>

  <entry>
    <title type="html"><![CDATA[Java Logging Quick Reference]]></title>
    <link href="http://alesnosek.com/blog/2015/05/11/java-logging-quick-reference/"/>
    <updated>2015-05-11T00:13:09-07:00</updated>
    <id>http://alesnosek.com/blog/2015/05/11/java-logging-quick-reference</id>
    <content type="html"><![CDATA[<p>The Simple Logging Facade for Java (SLF4J) serves as a simple abstraction for various logging frameworks. Let&rsquo;s look at how to configure SLF4J to work with SLF4J Simple logger, JDK 1.4 logger, Log4j, Logback and Log4j2 framework.</p>

<!-- more -->


<p>Following is a Java code of our logging application <code>LogApp</code>. Note that it uses SLF4J API classes to do the logging. The jar file <code>slf4j-api-1.7.12.jar</code> is the only compile time dependency.</p>

<figure class='code'><figcaption><span>LogApp.java </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LogApp</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">LogApp</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">log</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">&quot;Trace message&quot;</span><span class="o">);</span>
</span><span class='line'>      <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&quot;Debug message&quot;</span><span class="o">);</span>
</span><span class='line'>      <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;Info message&quot;</span><span class="o">);</span>
</span><span class='line'>      <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&quot;Warning message&quot;</span><span class="o">);</span>
</span><span class='line'>      <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&quot;Error message&quot;</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can compile the LogApp code with:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>javac -cp slf4j-api-1.7.12.jar LogApp.java
</span></code></pre></td></tr></table></div></figure>


<p>And run the LogApp with:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>java -cp .:slf4j-api-1.7.12.jar LogApp
</span></code></pre></td></tr></table></div></figure>


<p>The output shows that SLF4J is missing a logger implementation. In the following we&rsquo;ll demonstrate how to plug in different logging backends. The principle is always the same: include the logging framework implementation jars on the classpath, include the respective SLF4J adaptor jar on the classpath and provide a configuration file specific to the logging framework.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>SLF4J: Failed to load class "org.slf4j.impl.StaticLoggerBinder".
</span><span class='line'>SLF4J: Defaulting to no-operation (NOP) logger implementation
</span><span class='line'>SLF4J: See http://www.slf4j.org/codes.html#StaticLoggerBinder for further details.</span></code></pre></td></tr></table></div></figure>


<h2>SLF4J Simple logger</h2>

<p>The SLF4J comes with a Simple logger implemenation. Simple logger provides only basic functionality. It read its configuration from a <code>simplelogger.properties</code> file that must be included on the classpath. There&rsquo;s no way to specify a different location of the configuration file.</p>

<figure class='code'><figcaption><span>simplelogger.properties - Output to console </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='properties'><span class='line'><span class="na">org.slf4j.simpleLogger.logFile</span><span class="o">=</span><span class="s">System.out</span>
</span><span class='line'><span class="na">org.slf4j.simpleLogger.defaultLogLevel</span><span class="o">=</span><span class="s">debug</span>
</span><span class='line'><span class="na">org.slf4j.simpleLogger.showDateTime</span><span class="o">=</span><span class="s">true</span>
</span><span class='line'><span class="na">org.slf4j.simpleLogger.dateTimeFormat</span><span class="o">=</span><span class="s">HH:mm:ss.SSS</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>simplelogger.properties - Output to file </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='properties'><span class='line'><span class="na">org.slf4j.simpleLogger.logFile</span><span class="o">=</span><span class="s">/tmp/logger.out</span>
</span><span class='line'><span class="na">org.slf4j.simpleLogger.defaultLogLevel</span><span class="o">=</span><span class="s">debug</span>
</span><span class='line'><span class="na">org.slf4j.simpleLogger.showDateTime</span><span class="o">=</span><span class="s">true</span>
</span><span class='line'><span class="na">org.slf4j.simpleLogger.dateTimeFormat</span><span class="o">=</span><span class="s">HH:mm:ss.SSS</span>
</span></code></pre></td></tr></table></div></figure>


<p>Run the application with:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>java -cp .:slf4j-api-1.7.12.jar:slf4j-simple-1.7.12.jar LogApp
</span></code></pre></td></tr></table></div></figure>


<h2>JDK 1.4 logger (java.util.logging)</h2>

<p>The java.util.logging package was introduced in JDK 1.4. The default <code>logging.properties</code> configuration file that comes with JRE (<code>jre/lib/logging.properties</code>) specifies a ConsoleHandler that routes logging to System.err. There&rsquo;s no way how to configure the JDK 1.4 logger to log to standard output instead of standard error output unless you do the configuration programmaticaly. You can specify the location of your JDK 1.4 logging configuration file in <code>java.util.logging.config.file</code> Java property.</p>

<figure class='code'><figcaption><span>jdk14.stderr.properties - Output to console </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='properties'><span class='line'><span class="na">handlers</span><span class="o">=</span><span class="s">java.util.logging.ConsoleHandler</span>
</span><span class='line'><span class="na">.level</span><span class="o">=</span><span class="s">FINE</span>
</span><span class='line'><span class="na">java.util.logging.ConsoleHandler.level</span><span class="o">=</span><span class="s">FINE</span>
</span><span class='line'><span class="na">java.util.logging.ConsoleHandler.formatter</span><span class="o">=</span><span class="s">java.util.logging.SimpleFormatter</span>
</span><span class='line'><span class="c"># message pattern works since Java 7</span>
</span><span class='line'><span class="na">java.util.logging.SimpleFormatter.format</span><span class="o">=</span><span class="s">%1$tT [%2$s] %4$s - %5$s %6$s%n</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>jdk14.file.properties - Output to file </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='properties'><span class='line'><span class="na">handlers</span><span class="o">=</span><span class="s">java.util.logging.FileHandler</span>
</span><span class='line'><span class="na">.level</span><span class="o">=</span><span class="s">FINE</span>
</span><span class='line'><span class="na">java.util.logging.FileHandler.level</span><span class="o">=</span><span class="s">FINE</span>
</span><span class='line'><span class="na">java.util.logging.FileHandler.pattern</span><span class="o">=</span><span class="s">/tmp/logger.out</span>
</span><span class='line'><span class="na">java.util.logging.FileHandler.append</span><span class="o">=</span><span class="s">true</span>
</span><span class='line'><span class="na">java.util.logging.FileHandler.formatter</span><span class="o">=</span><span class="s">java.util.logging.SimpleFormatter</span>
</span><span class='line'><span class="c"># message pattern works since Java 7</span>
</span><span class='line'><span class="na">java.util.logging.SimpleFormatter.format</span><span class="o">=</span><span class="s">%1$tT [%2$s] %4$s - %5$s %6$s%n</span>
</span></code></pre></td></tr></table></div></figure>


<p>Run the application with:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>java -cp .:slf4j-api-1.7.12.jar:slf4j-jdk14-1.7.12.jar -Djava.util.logging.config.file<span class="o">=</span>/tmp/jdk14.stderr.properties LogApp
</span></code></pre></td></tr></table></div></figure>


<h2>Log4j</h2>

<p>The Log4j doesn&rsquo;t log a single message for you unless you provide it with a proper configuration:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>log4j:WARN No appenders could be found for logger (LogApp).
</span><span class='line'>log4j:WARN Please initialize the log4j system properly.
</span><span class='line'>log4j:WARN See http://logging.apache.org/log4j/1.2/faq.html#noconfig for more info.</span></code></pre></td></tr></table></div></figure>


<p>The following are the sample Log4j configuration files. Note that the <code>log4j.configuration</code> Java property that specifies the location of the configuration file must be a URL. In the example below the <code>/tmp/log4j.stdout.properties</code> location has to be prepended with <code>file:</code> to form a URL.</p>

<figure class='code'><figcaption><span>log4j.stdout.properties - Output to console </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='properties'><span class='line'><span class="na">log4j.rootLogger</span><span class="o">=</span><span class="s">DEBUG, stdout</span>
</span><span class='line'><span class="na">log4j.appender.stdout</span><span class="o">=</span><span class="s">org.apache.log4j.ConsoleAppender</span>
</span><span class='line'><span class="na">log4j.appender.stdout.Target</span><span class="o">=</span><span class="s">System.out</span>
</span><span class='line'><span class="na">log4j.appender.stdout.layout</span><span class="o">=</span><span class="s">org.apache.log4j.PatternLayout</span>
</span><span class='line'><span class="na">log4j.appender.stdout.layout.ConversionPattern</span><span class="o">=</span><span class="s">%d{HH:mm:ss} [%t] %-5p %c{1}:%L - %m%n</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>log4j.file.properties - Output to file </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='properties'><span class='line'><span class="na">log4j.rootLogger</span><span class="o">=</span><span class="s">DEBUG, file</span>
</span><span class='line'><span class="na">log4j.appender.file</span><span class="o">=</span><span class="s">org.apache.log4j.FileAppender</span>
</span><span class='line'><span class="na">log4j.appender.file.File</span><span class="o">=</span><span class="s">/tmp/logger.out</span>
</span><span class='line'><span class="na">log4j.appender.file.layout</span><span class="o">=</span><span class="s">org.apache.log4j.PatternLayout</span>
</span><span class='line'><span class="na">log4j.appender.file.layout.ConversionPattern</span><span class="o">=</span><span class="s">%d{HH:mm:ss} [%t] %-5p %c{1}:%L - %m%n</span>
</span></code></pre></td></tr></table></div></figure>


<p>Run the application with:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>java -cp .:slf4j-api-1.7.12.jar:slf4j-log4j12-1.7.12.jar:log4j-1.2.17.jar -Dlog4j.configuration<span class="o">=</span>file:/tmp/log4j.stdout.properties LogApp
</span></code></pre></td></tr></table></div></figure>


<h2>Logback</h2>

<p>With no configuration provided Logback defaults to printing all log messages on the console standard output. The <code>logback-classic</code> jar package that comes with Logback includes the <code>org.slf4j.impl.StaticLoggerBinder</code> class that serves as an adaptor to SLF4J framework. Therefore no extra SLF4J adaptor jar is needed on the runtime classpath. You can specify the location of your Logback configuration file in the <code>logback.configurationFile</code> Java property.</p>

<figure class='code'><figcaption><span>logback.stdout.xml - Output to console </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;configuration&gt;</span>
</span><span class='line'>  <span class="nt">&lt;appender</span> <span class="na">name=</span><span class="s">&quot;stdout&quot;</span> <span class="na">class=</span><span class="s">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;Target&gt;</span>System.out<span class="nt">&lt;/Target&gt;</span>
</span><span class='line'>    <span class="nt">&lt;encoder&gt;</span>
</span><span class='line'>      <span class="nt">&lt;pattern&gt;</span>%d{HH:mm:ss} [%t] %-5p %c{1}:%L - %m%n<span class="nt">&lt;/pattern&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/encoder&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/appender&gt;</span>
</span><span class='line'>  <span class="nt">&lt;root</span> <span class="na">level=</span><span class="s">&quot;DEBUG&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;appender-ref</span> <span class="na">ref=</span><span class="s">&quot;stdout&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/root&gt;</span>
</span><span class='line'><span class="nt">&lt;/configuration&gt;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>logback.file.xml - Output to file </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;configuration&gt;</span>
</span><span class='line'>  <span class="nt">&lt;appender</span> <span class="na">name=</span><span class="s">&quot;file&quot;</span> <span class="na">class=</span><span class="s">&quot;ch.qos.logback.core.FileAppender&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;File&gt;</span>/tmp/logger.out<span class="nt">&lt;/File&gt;</span>
</span><span class='line'>    <span class="nt">&lt;encoder&gt;</span>
</span><span class='line'>      <span class="nt">&lt;pattern&gt;</span>%d{HH:mm:ss} [%t] %-5p %c{1}:%L - %m%n<span class="nt">&lt;/pattern&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/encoder&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/appender&gt;</span>
</span><span class='line'>  <span class="nt">&lt;root</span> <span class="na">level=</span><span class="s">&quot;DEBUG&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;appender-ref</span> <span class="na">ref=</span><span class="s">&quot;file&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/root&gt;</span>
</span><span class='line'><span class="nt">&lt;/configuration&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Run the application with:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>java -cp .:slf4j-api-1.7.12.jar:logback-core-1.1.3.jar:logback-classic-1.1.3.jar -Dlogback.configurationFile=/tmp/logback.stdout.xml LogApp</span></code></pre></td></tr></table></div></figure>


<h2>Log4j2</h2>

<p>With no configuration provided Log4j2 informs you that it logs only error messages to stdout. You can provide the location of your Log4j2 configuration file in the <code>log4j.configurationFile</code> Java property.</p>

<figure class='code'><figcaption><span>lang </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ERROR StatusLogger No log4j2 configuration file found. Using default configuration: logging only errors to the console.
</span><span class='line'>22:09:13.052 [main] ERROR LogApp - Error message</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>log4j2.stdout.xml - Output to console </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;Configuration&gt;</span>
</span><span class='line'>    <span class="nt">&lt;Appenders&gt;</span>
</span><span class='line'>        <span class="nt">&lt;Console</span> <span class="na">name=</span><span class="s">&quot;console&quot;</span> <span class="na">target=</span><span class="s">&quot;SYSTEM_OUT&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>            <span class="nt">&lt;PatternLayout</span> <span class="na">pattern=</span><span class="s">&quot;%d{HH:mm:ss} [%t] %-5p %c{1}:%L - %m%n&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/Console&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/Appenders&gt;</span>
</span><span class='line'>    <span class="nt">&lt;Loggers&gt;</span>
</span><span class='line'>        <span class="nt">&lt;Root</span> <span class="na">level=</span><span class="s">&quot;debug&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>            <span class="nt">&lt;AppenderRef</span> <span class="na">ref=</span><span class="s">&quot;console&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/Root&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/Loggers&gt;</span>
</span><span class='line'><span class="nt">&lt;/Configuration&gt;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>log4j2.file.xml - Output to file </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;Configuration&gt;</span>
</span><span class='line'>    <span class="nt">&lt;Appenders&gt;</span>
</span><span class='line'>        <span class="nt">&lt;File</span> <span class="na">name=</span><span class="s">&quot;file&quot;</span> <span class="na">fileName=</span><span class="s">&quot;/tmp/logger.out&quot;</span> <span class="na">append=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>            <span class="nt">&lt;PatternLayout</span> <span class="na">pattern=</span><span class="s">&quot;%d{HH:mm:ss} [%t] %-5p %c{1}:%L - %m%n&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/File&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/Appenders&gt;</span>
</span><span class='line'>    <span class="nt">&lt;Loggers&gt;</span>
</span><span class='line'>        <span class="nt">&lt;Root</span> <span class="na">level=</span><span class="s">&quot;debug&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>            <span class="nt">&lt;AppenderRef</span> <span class="na">ref=</span><span class="s">&quot;file&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/Root&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/Loggers&gt;</span>
</span><span class='line'><span class="nt">&lt;/Configuration&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Run the application with:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>java -cp .:slf4j-api-1.7.12.jar:log4j-core-2.2.jar:log4j-api-2.2.jar:log4j-slf4j-impl-2.2.jar -Dlog4j.configurationFile<span class="o">=</span>/tmp/log4j2.stdout.xml LogApp
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>

  <entry>
    <title type="html"><![CDATA[Dynamic DNS with BIND and dhclient]]></title>
    <link href="http://alesnosek.com/blog/2015/05/02/dynamic-dns-with-bind-and-dhclient/"/>
    <updated>2015-05-02T19:21:43-07:00</updated>
    <id>http://alesnosek.com/blog/2015/05/02/dynamic-dns-with-bind-and-dhclient</id>
    <content type="html"><![CDATA[<p>In this blogpost we&rsquo;re going to configure the BIND server to accept dynamic updates. Client machines themselves will send the updates to the DNS server instead of letting DHCP server update the DNS. A great setup for situations where the DHCP server is not in your control.</p>

<!-- more -->


<p>Examples in this article work on RHEL6 that comes with BIND 9. You&rsquo;ll need to have <code>bind</code> and <code>bind-utils</code> RPM packages installed. In the following, the BIND server with host name <code>ns.somedomain.com</code> is an authoritative DNS server for the fictive zone <code>somedomain.com</code>.</p>

<h2>Dynamic DNS with BIND</h2>

<p>In our example we&rsquo;re going to configure the BIND server to accept DNS updates for <code>somedomain.com</code> zone from any client. In production environment you&rsquo;d use encryption keys to secure the access to the DNS server. You can read more on the secure configuration in <a href="http://linux.yyz.us/nsupdate/" title="nsupdate: Painless Dynamic DNS">this</a> excellent article. To allow any client to update the <code>somedomain.com</code> zone add the <code>allow-update { 0/0; };</code> option into your <code>/etc/named.conf</code> file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>zone "somedomain.com" in {
</span><span class='line'>        type master;
</span><span class='line'>        file "db.somedomain.com";
</span><span class='line'>        allow-update { 0/0; };
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<p>After restarting the DNS server with <code>sudo /etc/init.d/named restart</code> we can test that the DNS updates are working. Let&rsquo;s ask the DNS server <code>ns.somedomain.com</code> to register a host <code>somehost.somedomain.com</code> with IP address <code>192.168.100.200</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>nsupdate -d <span class="s">&lt;&lt; EOF</span>
</span><span class='line'><span class="s">server ns.somedomain.com</span>
</span><span class='line'><span class="s">update add somehost.somedomain.com 300 A 192.168.100.200</span>
</span><span class='line'><span class="s">send</span>
</span><span class='line'><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<p>If everything worked fine you should see <code>status: NOERROR</code> in the reply from update query. The DNS server created a new record in its database pairing the <code>somehost.somedomain.com</code> host name with the IP address <code>192.168.100.200</code>. Let&rsquo;s check that the host name resolution works by issuing:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>host somehost.somedomain.com ns.somedomain.com
</span></code></pre></td></tr></table></div></figure>


<p>You should see the IP address <code>192.168.100.200</code> in the command output. When on the DNS server you can dump the zone data into <code>/var/named/data/cache_dump.db</code> file for inspection:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>rndc dumpdb -all
</span></code></pre></td></tr></table></div></figure>


<h2>Updating DNS after IP acquisition</h2>

<p>Our virtual machines obtain their IP addresses via DHCP. Whenever the virtual machine obtains a new IP address or renews the lease we&rsquo;d like it to update the DNS accordingly. This way the DNS is always kept up to date and we&rsquo;re able to access the virtual machine using its host name.</p>

<p>The IP address acquisition is managed by the DHCP client <code>dhclient</code> running on the virtual machine. The <code>dhclient</code> can be extended by custom hooks. We are going to prepare a script that updates the DNS database whenever the virtual machine acquires an IP address. Our DNS update hook must be saved at <code>/etc/dhcp/dhclient-eth0-up-hooks</code>. The <code>/sbin/dhclient-script</code> shell script that comes with the <code>dhclient</code> package will execute the hook. Upon execution the hook is passed a <code>reason</code> variable describing the event.</p>

<p>To install the update hook on the virtual machine let&rsquo;s make use of Cloud-Init tool that I talked about in the <a href="http://alesnosek.com/blog/2015/04/26/using-cloud-init-outside-of-cloud/" title="Using Cloud-Init Outside of Cloud">previous blogpost</a>. The cloud-config script to be consumed by Cloud-Init looks as follows:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="c1">#cloud-config</span>
</span><span class='line'><span class="l-Scalar-Plain">fqdn</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">somehost.somedomain.com</span>
</span><span class='line'><span class="l-Scalar-Plain">write_files</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/etc/dhcp/dhclient-eth0-up-hooks</span>
</span><span class='line'>    <span class="l-Scalar-Plain">permissions</span><span class="p-Indicator">:</span> <span class="s">&#39;0755&#39;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">content</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
</span><span class='line'>      <span class="no">#!/bin/bash</span>
</span><span class='line'>      <span class="no">INTERFACE=eth0</span>
</span><span class='line'>      <span class="no">LEASE_FILE=/var/lib/dhclient/dhclient-$INTERFACE.leases</span>
</span><span class='line'>      <span class="no">HOST_ADDR=$(sed -n -e &#39;s/.*fixed-address \([0-9]\+\.[0-9]\+\.[0-9]\+\.[0-9]\+\).*/\1/p&#39; $LEASE_FILE | tail -1)</span>
</span><span class='line'>      <span class="no">HOST_NAME=$(hostname)</span>
</span><span class='line'>      <span class="no">NAMESERVER=ns.somedomain.com</span>
</span><span class='line'>      <span class="no">TTL=300</span>
</span><span class='line'>
</span><span class='line'>      <span class="no">if host $NAMESERVER 1&gt;/dev/null 2&gt;&amp;1; then</span>
</span><span class='line'>        <span class="no">case $reason in</span>
</span><span class='line'>          <span class="no">BOUND|RENEW|REBIND|REBOOT)</span>
</span><span class='line'>            <span class="no">nsupdate &lt;&lt; EOF</span>
</span><span class='line'>              <span class="no">server $NAMESERVER</span>
</span><span class='line'>              <span class="no">update delete $HOST_NAME A</span>
</span><span class='line'>              <span class="no">update add $HOST_NAME $TTL A $HOST_ADDR</span>
</span><span class='line'>              <span class="no">send</span>
</span><span class='line'>      <span class="no">EOF</span>
</span><span class='line'>          <span class="no">;;</span>
</span><span class='line'>        <span class="no">esac</span>
</span><span class='line'>      <span class="no">fi</span>
</span><span class='line'><span class="l-Scalar-Plain">runcmd</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">hostname somehost.somedomain.com</span> <span class="c1"># fix the hostname incorrectly set up by cloud-init</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">reason=BOUND /etc/dhcp/dhclient-eth0-up-hooks</span> <span class="c1"># DNS registration on first boot</span>
</span></code></pre></td></tr></table></div></figure>


<p>Upon the very first execution of the hook the machine&rsquo;s network setup is not complete yet. There&rsquo;s no <code>/etc/resolv.conf</code> file written yet and the default route is not configured. The condition <code>if host $NAMESERVER; then ...</code> skips the DNS update in this case. Later in the initialization process the <code>runcmd</code> part of the cloud-config script gets executed. At this time the network configuration is complete and so we execute the update hook manually. This is the first time that the virtual machine registers itself with DNS. Cloud-Init executes the <code>runcmd</code> section only on the very first boot. Subsequent boots won&rsquo;t execute the <code>runcmd</code> code.</p>

<p>Note that we&rsquo;re parsing the <code>/var/lib/dhclient/dhclient-eth0.leases</code> file to obtain the acquired IP address. Should the virtual machine obtain different IP address in the future the DNS entry gets updated accordingly.</p>
]]></content>
  </entry>

  <entry>
    <title type="html"><![CDATA[Using Cloud-Init Outside of Cloud]]></title>
    <link href="http://alesnosek.com/blog/2015/04/26/using-cloud-init-outside-of-cloud/"/>
    <updated>2015-04-26T13:04:25-07:00</updated>
    <id>http://alesnosek.com/blog/2015/04/26/using-cloud-init-outside-of-cloud</id>
    <content type="html"><![CDATA[<p>In EC2 and OpenStack cloud environments <em>user data</em> can be passed to the cloud instance to customize the cloud instance on the first boot. But what if your virtual machine doesn&rsquo;t run in the cloud environment? In this article we&rsquo;re going to configure our virtual machines with user data regardless if they&rsquo;re running in the cloud or not.</p>

<!-- more -->


<h2>Introducing Cloud-Init</h2>

<p><a href="https://cloudinit.readthedocs.org/en/latest/" title="Cloud-Init documentation">Cloud-Init</a> is a tool that handles early initialization of a cloud instance. The <code>cloud-init</code> RPM package should be installed on the disk image which the cloud instance is going to boot up from. The package installs init scripts into <code>/etc/rc.d/init.d</code> that makes Cloud-Init run early during the system initialization. Cloud-Init obtains user data passed to it by the cloud software and executes them. User data contains a set of configuration tasks for the cloud instance. For example, Cloud-Init can update machine&rsquo;s hostname, configure <code>/etc/hosts</code>, create users, configure SSH authorized keys, resize filesystems, manage disk mounts, run user-defined scripts and <a href="https://cloudinit.readthedocs.org/en/latest/topics/examples.html" title="Cloud config examples">much more</a>.</p>

<blockquote><p>Even if you&#8217;re not running your virtual machines in the cloud environment it&#8217;s worth it to deploy Clout-Init.</p></blockquote>


<p>Every cloud software comes with its own mechanism of how to pass the user data to the cloud instance. For example, EC2 provides a <em>magic IP</em> from which the instance can download its user data. OpenStack cloud attaches a special <em>config drive</em> to the cloud instance containing the user data to be consumed by Clout-Init. In order to pass the user data to our virtual machine let&rsquo;s go the OpenStack way and assemble a minimum config drive.</p>

<h2>Config drive assembly</h2>

<p>First, we&rsquo;re going to prepare the following file structure for our config drive:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>config_drive
</span><span class='line'>config_drive/openstack
</span><span class='line'>config_drive/openstack/latest
</span><span class='line'>config_drive/openstack/2012-08-10
</span><span class='line'>config_drive/openstack/2012-08-10/meta_data.json
</span><span class='line'>config_drive/openstack/2012-08-10/user_data</span></code></pre></td></tr></table></div></figure>


<p>Start by creating directories and the <code>latest</code> symbolic link like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mkdir config_drive
</span><span class='line'>mkdir -p config_drive/openstack/2012-08-10
</span><span class='line'>ln -s 2012-08-10 config_drive/openstack/latest</span></code></pre></td></tr></table></div></figure>


<p>Next create a minimum metadata file required by Cloud-Init. I&rsquo;m using a fully qualified domain name of the virtual machine as its UUID:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>cat &gt; config_drive/openstack/latest/meta_data.json <span class="s">&lt;&lt; EOF</span>
</span><span class='line'><span class="s">{</span>
</span><span class='line'><span class="s">    &quot;uuid&quot;: &quot;myinstance.mydomain.com&quot;</span>
</span><span class='line'><span class="s">}</span>
</span><span class='line'><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<p>Cloud-Init supports many <a href="https://cloudinit.readthedocs.org/en/latest/topics/format.html" title="Cloud-Init user data formats">formats</a> for scripts within user data. One of the most popular formats is the <em>cloud-config</em> file format. Let&rsquo;s create a cloud-config script that adds our SSH public key to the authorized keys for the user <code>root</code> on the virtual machine. We can then login into the virtual machine as user root without using a password. If you don&rsquo;t have a public-private SSH key pair you can quickly generate it using <code>ssh-keygen</code> command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>ssh-keygen -f mykey
</span></code></pre></td></tr></table></div></figure>


<p>Now create a <code>user_data</code> file with the configuration instructions for Cloud-Init. In the following code block replace the value of the <code>ssh-authorized-keys</code> field with the content of your generated <code>mykey.pub</code> file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>cat &gt; config_drive/openstack/latest/user_data <span class="s">&lt;&lt; EOF</span>
</span><span class='line'><span class="s">#cloud-config</span>
</span><span class='line'><span class="s">fqdn: myinstance.mydomain.com</span>
</span><span class='line'><span class="s">users:</span>
</span><span class='line'><span class="s">  - name: root</span>
</span><span class='line'><span class="s">    ssh-authorized-keys:</span>
</span><span class='line'><span class="s">      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDNH8Qwn4raGR1f9fvjbZe/GXM2N9Mh+eWlsFoYpcU4H5qf5YxT5CUo7BaTOgeE5geHyzxJQmCQlvoxcW3qkcjBJvVgEsTrrnX7KYS8BszvT4AMIuG2Za8f7myubXd6zYfj74XYhutUsPz7x2TEp9ZqbVkWcaElrQFxF2AzF7dV1RGntpPKyISqem70En8RYpGY514OLZ9TQDBYjbw8tfPuDd9mznXnWOZ34fPtP7+QDvOMFuA4tXsBpHj99/cbC0ViwzZtvb1QtY7dv9OFDgCRadw81+SKtzXctQ2rCYkb0huc0BCE7kLzinzlO62Znd+N1d+tpLAwP6i8Z5ZMXIJj user@machine</span>
</span><span class='line'><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<p>The file structure for our config drive is ready. Let&rsquo;s generate an ext2 filesystem and copy the files to it. The <code>virt-make-fs</code> utility from the <code>libguestfs-tools</code> package can help us with that:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>virt-make-fs config_drive disk.config
</span></code></pre></td></tr></table></div></figure>


<p>In order for Cloud-Init to detect the attached drive as config drive the filesystem on the config drive needs to be labeled <code>config-2</code>. You can use <code>e2label</code> command from the <code>e2fsprogs</code> package to label your config drive:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>e2label disk.config config-2
</span></code></pre></td></tr></table></div></figure>


<h2>Cloud-Init in action</h2>

<p>On my Linux host I&rsquo;m running <a href="http://libvirt.org/" title="Libvirt - The virtualization API">libvirt</a> to ease the management of virtual machines. You can install it by running <code>sudo yum install libvirt</code>. There is a handy command-line utility <code>virsh</code> which comes  with libvirt in the extra package <code>libvirt-client</code>.</p>

<p>Let&rsquo;s create a virtual machine with the config drive attached. As a virtual machine boot image I&rsquo;m using a CentOS-6 image from <a href="http://cloud.centos.org/centos/6/images/" title="CentOS-6 cloud images">cloud.centos.org</a> which comes with Cloud-Init built in. Make sure that your virtual machine boot image has Cloud-Init installed. Following is a virtual machine definition file for the CentoOS-6 virtual machine. You might need to change the location of the disk image files and save it as <code>CentOS-6.xml</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;domain</span> <span class="na">type=</span><span class="s">&#39;kvm&#39;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;name&gt;</span>CentOS-6<span class="nt">&lt;/name&gt;</span>
</span><span class='line'>  <span class="nt">&lt;memory</span> <span class="na">unit=</span><span class="s">&#39;KiB&#39;</span><span class="nt">&gt;</span>2097152<span class="nt">&lt;/memory&gt;</span>
</span><span class='line'>  <span class="nt">&lt;os&gt;</span>
</span><span class='line'>    <span class="nt">&lt;type&gt;</span>hvm<span class="nt">&lt;/type&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/os&gt;</span>
</span><span class='line'>  <span class="nt">&lt;devices&gt;</span>
</span><span class='line'>    <span class="nt">&lt;disk</span> <span class="na">type=</span><span class="s">&#39;file&#39;</span> <span class="na">device=</span><span class="s">&#39;disk&#39;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;driver</span> <span class="na">name=</span><span class="s">&quot;qemu&quot;</span> <span class="na">type=</span><span class="s">&quot;qcow2&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;source</span> <span class="na">file=</span><span class="s">&#39;/tmp/CentOS-6-x86_64-GenericCloud.qcow2&#39;</span><span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;target</span> <span class="na">bus=</span><span class="s">&quot;virtio&quot;</span> <span class="na">dev=</span><span class="s">&quot;vda&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/disk&gt;</span>
</span><span class='line'>    <span class="nt">&lt;disk</span> <span class="na">type=</span><span class="s">&#39;file&#39;</span> <span class="na">device=</span><span class="s">&#39;disk&#39;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;driver</span> <span class="na">name=</span><span class="s">&quot;qemu&quot;</span> <span class="na">type=</span><span class="s">&quot;raw&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;source</span> <span class="na">file=</span><span class="s">&#39;/tmp/disk.config&#39;</span><span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;target</span> <span class="na">bus=</span><span class="s">&quot;virtio&quot;</span> <span class="na">dev=</span><span class="s">&quot;vdb&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/disk&gt;</span>
</span><span class='line'>    <span class="nt">&lt;interface</span> <span class="na">type=</span><span class="s">&#39;network&#39;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;source</span> <span class="na">network=</span><span class="s">&#39;default&#39;</span><span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/interface&gt;</span>
</span><span class='line'>    <span class="nt">&lt;serial</span> <span class="na">type=</span><span class="s">&quot;file&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;source</span> <span class="na">path=</span><span class="s">&quot;/tmp/CentOS-6.log&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/serial&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/devices&gt;</span>
</span><span class='line'><span class="nt">&lt;/domain&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Okay, everything is ready, let&rsquo;s launch our Cloud-Init enabled CentOS-6 virtual machine:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>sudo virsh define CentOS-6.xml
</span><span class='line'>sudo virsh start CentOS-6
</span></code></pre></td></tr></table></div></figure>


<p>If everything went fine you can watch the console output of the booting virtual machine at <code>/tmp/CentOS-6.log</code>. Cloud-Init will print out the IP address obtained by the virtual machine (192.168.122.165 in my case) where we can login as root using the generated private key:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>ssh -i testkey root@192.168.122.165
</span></code></pre></td></tr></table></div></figure>


<p>Congratulations, your virtual machine has just been configured by Cloud-Init the same way as any other virtual machine running in the cloud environment.</p>
]]></content>
  </entry>

  <entry>
    <title type="html"><![CDATA[Five Basic Tips for Teamwork with Git]]></title>
    <link href="http://alesnosek.com/blog/2015/04/18/five-basic-tips-for-teamwork-with-git/"/>
    <updated>2015-04-18T16:51:08-07:00</updated>
    <id>http://alesnosek.com/blog/2015/04/18/five-basic-tips-for-teamwork-with-git</id>
    <content type="html"><![CDATA[<p>Do you care about how your Git commits look like? A great software practitioner does, indeed. Let&rsquo;s review a couple of basic tips for developers that make the Git commit log look good and teamwork with Git source control more fun.</p>

<!-- more -->


<h2>1) Introduce yourself to Git</h2>

<p>When searching through the commit history your fellow developers would like to recognize that this particular awesome commit was created by you. Before your first commit, please, introduce yourself to Git. Tell Git your name and email address:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>git config --global user.name <span class="s2">&quot;Ales Nosek&quot;</span>
</span><span class='line'>git config --global user.email <span class="s2">&quot;anosek@verimatrix.com&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>2) Commit message formatting</h2>

<p>Respect the conventions for Git commit message formatting. The first line of the commit message is a short (50 chars or less) summary. The first letter of the summary is capitalized and there&rsquo;s no dot at the end of the summary. The summary begins with a reference to the issue in your bug tracking system if available. Use imperative in your summary line as you&rsquo;d be commanding your code to do something, i.e. write &ldquo;Remove obsolete code&rdquo; instead of &ldquo;Removed obsolete code&rdquo; or &ldquo;Removes obsolete code&rdquo;. More detailed explanatory text comes after a blank line. Here is a model Git commit message:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>PROJXREF-27 Remove obsolete code in component X
</span><span class='line'>
</span><span class='line'>The logging functionality in component X is not needed anymore.
</span><span class='line'>Component Y took over the logging responsibility.</span></code></pre></td></tr></table></div></figure>


<p>See also this <a href="http://chris.beams.io/posts/git-commit/" title="How to Write a Git Commit Message">article</a> for more detailed explanation and examples.</p>

<h2>3) One commit per unit of work</h2>

<p>Create one commit per unit of work. A combined commit like &ldquo;Add method X, correct indention, clean up whitespaces&rdquo; is harder to review. Break your changes down into multiple commits, e.g. three commits &ldquo;Add method X&rdquo;, &ldquo;Correct indention&rdquo; and &ldquo;Clean up whitespaces&rdquo;.</p>

<h2>4) git diff <code>--</code>cached</h2>

<p>Before commiting <em>always</em> check your code changes. Make sure that your commit includes only the changes you intended to commit. Let your debug code and test modifications not flow into the production code base. Before committing double-check your changes with:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git diff --cached</span></code></pre></td></tr></table></div></figure>


<h2>5) Trailing whitespaces</h2>

<p>Whitespace changes in the commit diffs decrease the readability of the commit diffs and make code review less fun. You can configure your editor to remove the trailing whitespaces for you on file save. Perhaps a better option though is to instruct Git to clean up the trailing white spaces automatically before comitting. You can use the commit hook <a href="http://stackoverflow.com/questions/591923/make-git-automatically-remove-trailing-whitespace-before-committing/3516525#3516525" title="Make git automatically remove trailing whitespace before committing">here</a> to do exactly that. Save the commit hook as file named <code>pre-commit</code>. Install the <code>pre-commit</code> script into your Git repository:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cp pre-commit my_existing_repo/.git/hooks
</span><span class='line'>chmod 755 my_existing_repo/.git/hooks/pre-commit</span></code></pre></td></tr></table></div></figure>


<p>The pre-commit hook will run only before the commit in this particular Git repository. If you&rsquo;d like Git to install the pre-commit hook to every newly created/cloned repository you&rsquo;ll need to add the hook file into your template directory. First tell Git where is your template directory located by adding the following into your <code>~/.gitconfig</code> file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[init]
</span><span class='line'>        templatedir = ~/.gittemplate</span></code></pre></td></tr></table></div></figure>


<p>Now you can create your Git template directory and copy the <code>pre-commit</code> hook file into it:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mkdir -p ~/.gittemplate/hooks
</span><span class='line'>cp pre-commit ~/.gittemplate/hooks
</span><span class='line'>chmod 755 ~/.gittemplate/hooks/pre-commit</span></code></pre></td></tr></table></div></figure>


<p>From now on whenever you create/clone a Git repository you should find the <code>pre-commit</code> hook file installed at <code>.git/hooks/pre-commit</code>. Git will clean up trailing whitespaces for you before you commit.</p>
]]></content>
  </entry>

</feed>
